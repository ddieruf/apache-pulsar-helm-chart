suite: Test %%CHART_NAME%% certificate
release:
  name: zz
  namespace: xx
templates:
  - charts/%%CHART_NODE_NAME%%/templates/certificate.yaml
  - charts/%%CHART_NODE_NAME%%/templates/jks_secret.yaml
tests:
  - it: should be correct certificate document
    set:
      global:
        interComponentTls:
          enabled: true
      %%CHART_NODE_NAME%%:
        certificateResources:
          tlsSecretName: null
          jksPasswordSecretName: null
          certificateRequest:
            issuerRef:
              name: some-issuer
              kind: ClusterIssuer
    asserts:
      - containsDocument:
          kind: Certificate
          apiVersion: cert-manager.io/v1
    template: charts/%%CHART_NODE_NAME%%/templates/certificate.yaml

  - it: should be correct secret document
    set:
      global:
        interComponentTls:
          enabled: true
      %%CHART_NODE_NAME%%:
        certificateResources:
          tlsSecretName: null
          jksPasswordSecretName: null
          certificateRequest:
            issuerRef:
              name: some-issuer
              kind: ClusterIssuer
    asserts:
      - containsDocument:
          kind: Secret
          apiVersion: v1
    template: charts/%%CHART_NODE_NAME%%/templates/jks_secret.yaml

  - it: should have correct certificate metadata
    set:
      global:
        commonLabels:
          aaa: bbb
        commonAnnotations:
          ccc: ddd
        interComponentTls:
          enabled: true
      %%CHART_NODE_NAME%%:
        certificateResources:
          tlsSecretName: null
          jksPasswordSecretName: null
          certificateRequest:
            issuerRef:
              name: some-issuer
              kind: ClusterIssuer
    asserts:
      - equal:
          path: metadata
          value:
            annotations:
              ccc: ddd
            labels:
              aaa: bbb
              app.kubernetes.io/component: %%CHART_NAME%%
              app.kubernetes.io/instance: zz
              app.kubernetes.io/managed-by: Helm
              app.kubernetes.io/name: %%CHART_NAME%%
              app.kubernetes.io/part-of: apache-pulsar
              helm.sh/chart: %%CHART_NODE_NAME%%-0.1.0
            name: %%CHART_NAME%%-certificate
            namespace: xx
    template: charts/%%CHART_NODE_NAME%%/templates/certificate.yaml

  - it: should have correct secret metadata
    set:
      global:
        commonLabels:
          aaa: bbb
        commonAnnotations:
          ccc: ddd
        interComponentTls:
          enabled: true
      %%CHART_NODE_NAME%%:
        certificateResources:
          tlsSecretName: null
          jksPasswordSecretName: null
          certificateRequest:
            issuerRef:
              name: some-issuer
              kind: ClusterIssuer
      asserts:
        - equal:
            path: metadata
            value:
              annotations:
                ccc: ddd
              labels:
                aaa: bbb
                app.kubernetes.io/component: %%CHART_NAME%%
                app.kubernetes.io/instance: zz
                app.kubernetes.io/managed-by: Helm
                app.kubernetes.io/name: %%CHART_NAME%%
                app.kubernetes.io/part-of: pulsar-luna
                helm.sh/chart: %%CHART_NODE_NAME%%-0.1.0
              name: %%CHART_NAME%%-jks
              namespace: xx
      template: charts/%%CHART_NODE_NAME%%/templates/jks_secret.yaml

  - it: should build correct certificate request
    template: charts/%%CHART_NODE_NAME%%/templates/certificate.yaml
    set:
      global:
        clusterDomain: domain.com
        interComponentTls:
          enabled: true
      %%CHART_NODE_NAME%%:
        certificateResources:
          tlsSecretName: null
          jksPasswordSecretName: null
          certificateRequest:
            issuerRef:
              name: cert-issuer
              kind: ClusterIssuer
    asserts:
      - equal:
          path: spec.commonName
          value: zz-%%CHART_NAME%%
      - contains:
          path: spec.dnsNames
          content:
            '*.%%CHART_NAME%%-headless.xx.svc.domain.com'
      - contains:
          path: spec.dnsNames
          content:
            127.0.0.1
      - contains:
          path: spec.dnsNames
          content:
            localhost
      - equal:
          path: spec.secretName
          value: %%CHART_NAME%%-tls

  - it: should build correct certificate request with global values
    template: charts/%%CHART_NODE_NAME%%/templates/certificate.yaml
    set:
      global:
        clusterDomain: domain.com
        interComponentTls:
          enabled: true
          tlsSecretName: null
          jksPasswordSecretName: null
          issuerRef:
            name: cluster-cert-issuer
            kind: ClusterIssuer
      %%CHART_NODE_NAME%%:
        certificateResources:
          tlsSecretName: null
          jksPasswordSecretName: null
          certificateRequest:
            issuerRef:
    asserts:
      - equal:
          path: spec.commonName
          value: zz-%%CHART_NAME%%
      - contains:
          path: spec.dnsNames
          content:
            '*.%%CHART_NAME%%-headless.xx.svc.domain.com'
      - contains:
          path: spec.dnsNames
          content:
            127.0.0.1
      - contains:
          path: spec.dnsNames
          content:
            localhost
      - equal:
          path: spec.secretName
          value: %%CHART_NAME%%-tls
      - equal:
          path: spec.issuerRef
          value:
            name: cluster-cert-issuer
            kind: ClusterIssuer