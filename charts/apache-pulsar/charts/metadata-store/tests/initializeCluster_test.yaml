suite: Test metadata-store initialize cluster
release:
  name: zz
  namespace: xx
templates:
  - charts/metadataStore/templates/jobs/initialize-cluster-metadata.yaml
tests:
  - it: should be correct document
    asserts:
      - containsDocument:
          kind: Job
          apiVersion: batch/v1

  - it: should have correct metadata
    set:
      global:
        commonLabels:
          aaa: bbb
        commonAnnotations:
          ccc: ddd
    asserts:
      - equal:
          path: metadata
          value:
            annotations:
              ccc: ddd
            labels:
              aaa: bbb
              app.kubernetes.io/component: metadata-store
              app.kubernetes.io/instance: zz
              app.kubernetes.io/managed-by: Helm
              app.kubernetes.io/name: metadata-store
              app.kubernetes.io/part-of: apache-pulsar
              helm.sh/chart: metadataStore-0.1.0
            name: metadata-store-initialize-cluster-metadata
            namespace: xx

  - it: should wait for statefulset pods to be running
    asserts:
      - equal:
          path: spec.template.spec.initContainers[0].name
          value: metadata-store-statefulset-running

  - it: should build initialize arguments
    set:
      global:
        clusterDomain: domain.com
        interComponentTls:
          enabled: false
        metadataStore:
          replicas: 1
          nonPersistentReplicas: 1
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: "initialize-cluster-metadata"
      - matchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: --cluster "zz"
      - matchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: --metadata-store "zk:metadata-store-statefulset-0.metadata-store-headless.xx.svc.domain.com:2181,metadata-store-statefulset-non-persistent-0.metadata-store-headless.xx.svc.domain.com:2181"
      - matchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: --configuration-metadata-store "zk:metadata-store-statefulset-0.metadata-store-headless.xx.svc.domain.com:2181,metadata-store-statefulset-non-persistent-0.metadata-store-headless.xx.svc.domain.com:2181"
      - matchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: --web-service-url "http://broker-service-headless.xx.svc.domain.com:8080"
      - matchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: --broker-service-url "pulsar://broker-service-headless.xx.svc.domain.com:6650"

  - it: should build initialize arguments with tls
    set:
      global:
        clusterDomain: domain.com
        interComponentTls:
          enabled: true
        metadataStore:
          replicas: 1
          nonPersistentReplicas: 1
    asserts:
#      - matchRegex:
#          path: spec.template.spec.containers[0].args[0]
#          pattern: --broker-service-url-tls "pulsar+ssl://broker-service-headless.xx.svc.domain.com:6651"
      - matchRegex:
          path: spec.template.spec.containers[0].args[0]
          pattern: --web-service-url-tls "https://broker-service-headless.xx.svc.domain.com:8081"