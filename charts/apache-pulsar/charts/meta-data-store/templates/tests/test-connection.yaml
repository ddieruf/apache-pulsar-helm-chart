apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "meta-data-store.name" . }}-test"
  labels: {{ include "common.labels.standard" (dict "name" (include "meta-data-store.name" $) "context" $ ) | nindent 4 }}
  annotations:
    "helm.sh/hook": test
spec:
  restartPolicy: Never
  containers:
    - name: test-meta-data-store
      image: busybox:latest
      command: ['sh','-c']
      args:
        - >
          {{- range $idx,$address := (include "meta-data-store.quorum-cluster-addresses" $ | fromJson) -}}
            {{- $addressNoPorts := ($address | replace ":2888:3888" "") -}}
            {{- printf "[[(\"$(echo ruok | nc %s 2181)\" == \"imok\")]] || exit 1 &&" $addressNoPorts | nindent 10 -}}
            {{- printf "[[(\"$(echo stat | nc %s 2181 | grep Connections)\" == \"Connections: 1\")]] || exit 1 &&" $addressNoPorts | nindent 10 -}}
            {{- printf "[[(\"$(echo isro | nc %s 2181)\" == \"rw\")]] || exit 1 &&" $addressNoPorts | nindent 10 -}}
          {{- end -}}
{{/*          keytool -list -v -keystore keystore.jks*/}}
{{/*          openssl s_client -verify 100 -showcerts -connect $HOST:$PORT -CAfile  <(keytool -list -rfc -keystore truststore.jks -storepass changeit)
              openssl s_client -debug -connect localhost:3181 -tls1 */}}
          {{- print  "echo \"all done\"" | nindent 10 -}}