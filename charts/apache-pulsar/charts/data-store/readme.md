# Pulsar Bookkeeper

Pulsar creates it's own version of Bookkeeper bookies but follows the general principles of Bookkeeper administration. There are noticeably less config values to choose from because Pulsar can make assumptions from it's own configuration.

## Startup Flow

As the helm chart starts a pulsar based Bookkeeper instance there is work done to get it's configuration ready. One of the jobs of this chart is to
make configuration straight forward and do the work of converting the desired values into a format that Pulsar Bookkeeper understands.

1. Write the provided values in `.config` into a configmap
2. Attach that configmap to each Bookkeeper instance
3. Use `scripts/apply-config-from-env.py` python script (provided in the Pulsar container) as a container arg, to convert the attached env values into `conf/Bookkeeper.conf`
4. Start the Pulsar Bookkeeper instance, providing the location of the conf file

## Configuration

Given the version tag of Pulsar container being used in this chart, the labels and values within the `.config` area should follow Pulsar's options. You'll notice only a few of the possible configuration values are set. These are very specific things to running a Pulsar cluster in Kubernetes and the defaults need to be changed.

The list of possible configuration values is long. Include them as you see fit. Refer to [Pulsar's Bookkeeper documentation](https://pulsar.apache.org/docs/next/reference-configuration-bookkeeper) for all possibilities and the default values.

*Note* - the use of the prefix "PULSAR_PREFIX_" with some values. This is used so when `scripts/apply-config-from-env.py` runs, these values will be converted into Bookkeeper conf.

## Statefulset versus Daemonset

You have the option to run the bookie(s) as either [StatefulSet](https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/) or [DaemonSet](https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/) objects. [Bookkeeper documentation](https://bookkeeper.apache.org/docs/deployment/kubernetes) recommends DaemonSet, so that is the default of this chart. But DaemonSet isn't always an option in all K8s installs. So the alternate StatefulSet is offered. Set the `.asStatefulSet: true` value to deploy as StatefulSet.

*Note* - a big difference between Daemonset and Statefulset is the replica count. As a Daemonset, replicaCount is decided by the number of hosts in the cluster. The `.replicaCount` value is ignored. Does this work for your needs?

## Headless service

Bookkeeper recommends deploying each bookie service as [headless](https://kubernetes.io/docs/concepts/services-networking/service/#headless-services). Because all that's needed in the cluster are DNS records, there is no external access/routing needed. This chart follows that pattern.

## Disks

You are most likely using Pulsar for its guaranteed delivery and persistent store. The data store facilities that. Its disk(s) are at the heart of those options. First, the chart offers an overall `.persistence.enabled` option. If set to `false` no cluster data will survive an instance restart or reschedule. That option is really just for development purposes. The default is `true`.

There are 2 main areas of data - "journals" and "ledgers". Both of which area a part of persisting messages. The chart offers an option to combine these areas into a single disk, as `.persistence.oneDisk.enabled`. The default is `false` but if set to `true`, the journals and ledgers will be stored on a single disk in separate folders. There is no real advantage to this option, it's just a convenience to have them as one. Or could make a development environment a little less complicated.

The default is to give journals and ledgers their own disk. While this does add a some complication to the statefulset, it offers the most flexibility when choosing sizing and storage class.

If you are using function workers, is an option for an additional "ranges" disk which stores function state. This disk is not enabled by default but if `.persistence.ranges.enabled` is set to `true` then a third disk will be created. If the ranges disk is enabled and `.persistence.oneDisk.enabled` is also set to `true`, then ranges will be given its own folder on that single disk.

To facilitate data durability, this chart offers an option to create a storage class for each data type automatically. When persistence is enabled, and both `storageClass` and `existingClaim` are left blank on any data type, a new `storageClass` object will be created in the namespace. The storageClass objects are specific to the chosen storage strategy. If the `oneDisk` option is enabled but neither `.persistence.oneDisk.storageClass` or `.persistence.oneDisk.existingClaim` are provided, the cluster will not start properly.

## Bookie Cluster

This chart assumes a Zookeeper meta data store has already been created. There is a required value of `.config.PULSAR_PREFIX_zkServers` where a comma delimited list of Zookeeper addresses (with client port) is expected. An example value would be: `zk-1.default.svc.cluster.local:2181,zk-2.default.svc.cluster.local:2181,zk-3.default.svc.cluster.local:2181`. With this each Bookie instance is given the ability to retrieve its configuration from a Zookeeper leader.

During the chart's installation (ie: `.Release.IsInstall = true`) a Kubernetes job is created that attempts to configure a Bookkeeper cluster. This is done using the bookkeeper CLI command [`bin/bookkeeper shell initnewcluster`](https://bookkeeper.apache.org/docs/reference/cli#bookkeeper-shell-initnewcluster). The job uses the same configuration as the Bookies.

*Note* - there is also a helm template that can override the `.config.PULSAR_PREFIX_zkServers` value. The reason for this additional option is, when creating a new cluster the address of each Zookeeper instance is calculated. So only when an entire cluster's chart is calculated does one know what this value should be. So offering this function allows the parent chart to override the template which in turn override's the value. The parent template calculates the correct value.

## Parameters

### Image parameters

Component image version. See the Admin Console image repository [here](https://hub.docker.com/r/datastax/pulsar-admin-console).

| Name                | Description                                          | Value                    |
| ------------------- | ---------------------------------------------------- | ------------------------ |
| `image.registry`    | Component image registry                             | `""`                     |
| `image.repository`  | Component image repository                           | `datastax/lunastreaming` |
| `image.tag`         | Component image tag (immutable tags are recommended) | `2.8.3_1.0.11`           |
| `image.pullPolicy`  | Component image pull policy                          | `IfNotPresent`           |
| `image.pullSecrets` | Specify docker-registry secret names as an array     | `[]`                     |


### Certificate Resources

Configure the component's certificate

| Name                                                            | Description                                                                                                                                           | Value    |
| --------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| `certificateResources.tlsSecretName`                            |                                                                                                                                                       | `nil`    |
| `certificateResources.jksPasswordSecretName`                    |                                                                                                                                                       | `nil`    |
| `certificateResources.certificateRequest`                       | Refer to the [CertificateSpec](https://cert-manager.io/docs/reference/api-docs/#cert-manager.io/v1.CertificateSpec) for more info about these values. |          |
| `certificateResources.certificateRequest.renewBefore`           | How long before the currently issued certificate’s expiry cert-manager should renew the certificate                                                   | `60days` |
| `certificateResources.certificateRequest.duration`              | The requested ‘duration’ (i.e. lifetime) of the Certificate                                                                                           | `90days` |
| `certificateResources.certificateRequest.subject.organizations` | Organizations to be used on the Certificate                                                                                                           | `[]`     |
| `certificateResources.certificateRequest.privateKey`            | Options to control private keys used for the Certificate                                                                                              | `{}`     |
| `certificateResources.certificateRequest.issuerRef`             | IssuerRef is a reference to the issuer for this certificate                                                                                           | `{}`     |


### Pulsar Environment Configuration

| Name                                 | Description                                                                                                                          | Value                                                                                                                                               |
| ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------- |
| `pulsarEnv.bookieGc`                 | JVM settings for bookie garbage collection                                                                                           | `--XX:+UseG1GC`                                                                                                                                     |
| `pulsarEnv.gc`                       | JVM settings for garbage collection                                                                                                  | `-XX:+UseG1GC`                                                                                                                                      |
| `pulsarEnv.mem`                      | JVM memory settings                                                                                                                  | `-Xms2g -Xmx2g -XX:MaxDirectMemorySize=2g -Dio.netty.leakDetectionLevel=disabled -Dio.netty.recycler.linkCapacity=1024 -XX:+ExitOnOutOfMemoryError` |
| `pulsarEnv.log4j.formatMsgNoLookups` | Disables message pattern lookups globally when set to true. This is equivalent to defining all message patterns using %m{nolookups}. | `true`                                                                                                                                              |
| `pulsarEnv.loggingLevels.root`       | Applies the PULSAR_LOG_ROOT_LEVEL env var and pulsar.log.root.level JVM option                                                       | `error`                                                                                                                                             |
| `pulsarEnv.loggingLevels.pulsar`     | Applies the PULSAR_LOG_LEVEL env var                                                                                                 | `error`                                                                                                                                             |
| `pulsarEnv.extraOpts`                | A collection of extra options to be passed to the jvm. Format each as the entire key/value, ie: "-Dzookeeper.tcpKeepAlive=true"      | `["-Dzookeeper.tcpKeepAlive=true","-Dzookeeper.clientTcpKeepAlive=true"]`                                                                           |
| `pulsarEnv.extraClasspath`           | A collection of extra paths for the pulsar classpath. Include just the folder or file path, no delimiter.                            | `[]`                                                                                                                                                |


### Data store configuration

Configure data store settings. Refer to the [project's documentation](https://pulsar.apache.org/docs/next/reference-configuration-bookkeeper) for a full spec.

> Note, the values not documented here are set by the parent chart

| Name                                             | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | Value                                                              |
| ------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------ |
| `replicas`                                       | The number of bookies to deploy                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `3`                                                                |
| `config.allowMultipleDirsUnderSameDiskPartition` | Configure the bookie to enable/disable multiple ledger/index/journal directories in the same filesystem disk partition.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `false`                                                            |
| `config.allowStorageExpansion`                   | Allow the bookie storage to expand. Newly added ledger and index dirs must be empty.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | `false`                                                            |
| `config.auditorPeriodicBookieCheckInterval`      | The interval between auditor bookie checks. The auditor bookie check, checks ledger metadata to see which bookies should contain entries for each ledger. If a bookie which should contain entries is unavailable, thea the ledger containing that entry is marked for recovery. Setting this to 0 disabled the periodic check. Bookie checks will still run when a bookie fails. The interval is specified in seconds.                                                                                                                                                                                                             | `86400`                                                            |
| `config.auditorPeriodicCheckInterval`            | Interval at which the auditor will do a check of all ledgers in the cluster. By default this runs once a week. The interval is set in seconds. To disable the periodic check completely, set this to 0. Note that periodic checking will put extra load on the cluster, so it should not be run more frequently than once a day.                                                                                                                                                                                                                                                                                                    | `604800`                                                           |
| `config.autoRecoveryDaemonEnabled`               | Whether the bookie itself can start auto-recovery service.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `true`                                                             |
| `config.bookieAuthProviderFactoryClass`          | The factory class name of the bookie authentication provider. If this is null, then there is no authentication.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `nil`                                                              |
| `config.bookieDeathWatchInterval`                | Interval to watch whether bookie is dead or not, in milliseconds                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `1000`                                                             |
| `config.byteBufAllocatorSizeMax`                 | The maximum buf size of the received ByteBuf allocator.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `1048576`                                                          |
| `config.compactionMaxOutstandingRequests`        | Sets the maximum number of entries that can be compacted without flushing. When compacting, the entries are written to the entrylog and the new offsets are cached in memory. Once the entrylog is flushed the index is updated with the new offsets. This parameter controls the number of entries added to the entrylog before a flush is forced. A higher value for this parameter means more memory will be used for offsets. Each offset consists of 3 longs. This parameter should not be modified unless you’re fully aware of the consequences.                                                                             | `100000`                                                           |
| `config.compactionRate`                          | The rate at which compaction will read entries, in adds per second.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `1000`                                                             |
| `config.compactionRateByBytes`                   | Set the rate at which compaction reads entries. The unit is bytes added per second.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `1000000`                                                          |
| `config.compactionRateByEntries`                 | The rate at which compaction will read entries, in adds per second.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `1000`                                                             |
| `config.dbStorage_readAheadCacheBatchSize`       | How many entries to pre-fill in cache after a read cache miss                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `1000`                                                             |
| `config.dbStorage_readAheadCacheMaxSizeMb`       | Size of Read cache. Memory is allocated from JVM direct memory. This read cache is pre-filled doing read-ahead whenever a cache miss happens. By default, it is allocated to 25% of the available direct memory.                                                                                                                                                                                                                                                                                                                                                                                                                    | `nil`                                                              |
| `config.dbStorage_rocksDB_blockCacheSize`        | Size of RocksDB block-cache. For best performance, this cache should be big enough to hold a significant portion of the index database which can reach ~2GB in some cases. By default, it uses 10% of direct memory.                                                                                                                                                                                                                                                                                                                                                                                                                | `nil`                                                              |
| `config.dbStorage_rocksDB_blockSize`             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `65536`                                                            |
| `config.dbStorage_rocksDB_bloomFilterBitsPerKey` |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `10`                                                               |
| `config.dbStorage_rocksDB_maxSizeInLevel1MB`     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `256`                                                              |
| `config.dbStorage_rocksDB_numFilesInLevel0`      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `4`                                                                |
| `config.dbStorage_rocksDB_numLevels`             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `-1`                                                               |
| `config.dbStorage_rocksDB_sstSizeInMB`           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `64`                                                               |
| `config.dbStorage_rocksDB_writeBufferSizeMB`     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `64`                                                               |
| `config.dbStorage_writeCacheMaxSizeMb`           | Size of Write Cache. Memory is allocated from JVM direct memory. Write cache is used to buffer entries before flushing into the entry log. For good performance, it should be big enough to hold a substantial amount of entries in the flush interval.                                                                                                                                                                                                                                                                                                                                                                             | `nil`                                                              |
| `config.disableServerSocketBind`                 | Whether the bookie is allowed to disable bind on network interfaces. This bookie will be available only to BookKeeper clients executed on the local JVM.                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | `false`                                                            |
| `config.diskCheckInterval`                       | Disk check interval in milli seconds, interval to check the ledger dirs usage.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `10000`                                                            |
| `config.diskUsageThreshold`                      | For each ledger dir, maximum disk space which can be used. Default is 0.95f. i.e. 95% of disk can be used at most after which nothing will be written to that partition. If all ledger dir partitions are full, then bookie will turn to readonly mode if ‘readOnlyModeEnabled=true’ is set, else it will shutdown. Valid values should be in between 0 and 1 (exclusive).                                                                                                                                                                                                                                                          | `0.95`                                                             |
| `config.enableLocalTransport`                    | Whether the bookie is allowed to listen for the BookKeeper clients executed on the local JVM.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `false`                                                            |
| `config.entryLogFilePreallocationEnabled`        | Enable or disable entry logger preallocation                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | `true`                                                             |
| `config.flushEntrylogBytes`                      | Entry log flush interval in bytes. Flushing in smaller chunks but more frequently reduces spikes in disk I/O. Flushing too frequently may also affect performance negatively.                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `268435456`                                                        |
| `config.flushInterval`                           | How long the interval to flush ledger index pages to disk, in milliseconds. Flushing index files will introduce much random disk I/O. If separating journal dir and ledger dirs each on different devices, flushing would not affect performance. But if putting journal dir and ledger dirs on same device, performance degrade significantly on too frequent flushing. You can consider increment flush interval to get better performance, but you need to pay more time on bookie server restart after failure.                                                                                                                 | `60000`                                                            |
| `config.forceReadOnlyBookie`                     | Whether the bookie is force started in read only mode.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `false`                                                            |
| `config.gcOverreplicatedLedgerWaitTime`          | How long the interval to trigger next garbage collection of overreplicated ledgers, in milliseconds. This should not be run very frequently since we read the metadata for all the ledgers on the bookie from zk.                                                                                                                                                                                                                                                                                                                                                                                                                   | `86400000`                                                         |
| `config.gcWaitTime`                              | How long the interval to trigger next garbage collection, in milliseconds. Since garbage collection is running in background, too frequent gc will heart performance. It is better to give a higher number of gc interval if there is enough disk capacity.                                                                                                                                                                                                                                                                                                                                                                         | `900000`                                                           |
| `config.httpServerClass`                         | The http server class.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `org.apache.bookkeeper.http.vertx.VertxHttpServer`                 |
| `config.httpServerEnabled`                       | The flag enables/disables starting the admin http server.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | `false`                                                            |
| `config.isForceGCAllowWhenNoSpace`               | Whether force compaction is allowed when the disk is full or almost full. Forcing GC could get some space back, but could also fill up the disk space more quickly. This is because new log files are created before GC, while old garbage log files are deleted after GC.                                                                                                                                                                                                                                                                                                                                                          | `false`                                                            |
| `config.isThrottleByBytes`                       | Throttle compaction by bytes or by entries.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `false`                                                            |
| `config.journalAdaptiveGroupWrites`              | Whether to group journal force writes, which optimizes group commit for higher throughput.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `true`                                                             |
| `config.journalAlignmentSize`                    | All the journal writes and commits should be aligned to given size                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | `4096`                                                             |
| `config.journalBufferedWritesThreshold`          | Maximum writes to buffer to achieve grouping                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | `524288`                                                           |
| `config.journalFlushWhenQueueEmpty`              | If we should flush the journal when journal queue is empty                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `false`                                                            |
| `config.journalMaxBackups`                       | The max number of old journal files to keep. Keeping a number of old journal files would help data recovery in special cases.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `5`                                                                |
| `config.journalMaxGroupWaitMSec`                 | The maximum latency to impose on a journal write to achieve grouping.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | `1`                                                                |
| `config.journalMaxSizeMB`                        | Max file size of journal file, in megabytes. A new journal file will be created when the old one reaches the file size limitation.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | `2048`                                                             |
| `config.journalPreAllocSizeMB`                   | How space to pre-allocate at a time in the journal.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `16`                                                               |
| `config.journalRemoveFromPageCache`              | Whether pages should be removed from the page cache after force write.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `true`                                                             |
| `config.journalWriteBufferSizeKB`                | The of the write buffers used for the journal.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `64`                                                               |
| `config.ledgerManagerType`                       | The type of ledger manager used to manage how ledgers are stored, managed, and garbage collected. See BookKeeper Internals for [more info](http://bookkeeper.apache.org/docs/latest/getting-started/concepts).                                                                                                                                                                                                                                                                                                                                                                                                                      | `hierarchical`                                                     |
| `config.ledgerStorageClass`                      | Ledger storage implementation class                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `org.apache.bookkeeper.bookie.storage.ldb.DbLedgerStorage`         |
| `config.logSizeLimit`                            | Max file size of the entry logger, in bytes. A new entry log file will be created when the old one reaches the file size limitation.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | `1073741824`                                                       |
| `config.lostBookieRecoveryDelay`                 | How long to wait, in seconds, before starting auto recovery of a lost bookie.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `0`                                                                |
| `config.majorCompactionInterval`                 | The time interval to run major compaction, in seconds. If set to less than zero, the major compaction is disabled. Note: should be greater than gcWaitTime.                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `86400`                                                            |
| `config.majorCompactionThreshold`                | The threshold of major compaction. Entry log files whose remaining size percentage reaches below this threshold will be compacted in a major compaction. Those entry log files whose remaining size percentage is still higher than the threshold will never be compacted. If set to less than zero, the minor compaction is disabled.                                                                                                                                                                                                                                                                                              | `0.5`                                                              |
| `config.maxPendingAddRequestsPerThread`          | The limited number of pending requests, which is used to avoid the executor queue to grow indefinitely when add workers threads are enabled.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | `10000`                                                            |
| `config.maxPendingReadRequestsPerThread`         | If read workers threads are enabled, limit the number of pending requests, to avoid the executor queue to grow indefinitely.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | `2500`                                                             |
| `config.minorCompactionInterval`                 | Time interval to run minor compaction, in seconds. If set to less than zero, the minor compaction is disabled. Note: should be greater than gcWaitTime.                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `3600`                                                             |
| `config.minorCompactionThreshold`                | Threshold of minor compaction. Entry log files whose remaining size percentage reaches below this threshold will be compacted in a minor compaction. If set to less than zero, the minor compaction is disabled.                                                                                                                                                                                                                                                                                                                                                                                                                    | `0.2`                                                              |
| `config.minUsableSizeForIndexFileCreation`       | The minimum safe usable size available in index directory for bookie to create index files while replaying journal at the time of bookie starts in Readonly Mode (in bytes).                                                                                                                                                                                                                                                                                                                                                                                                                                                        | `1073741824`                                                       |
| `config.nettyMaxFrameSizeBytes`                  | The maximum netty frame size in bytes. Any message received larger than this will be rejected.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `5253120`                                                          |
| `config.numAddWorkerThreads`                     | The number of threads that should handle write requests. if zero, the writes would be handled by netty threads directly.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | `0`                                                                |
| `config.numHighPriorityWorkerThreads`            | The umber of threads that should be used for high priority requests (i.e. recovery reads and adds, and fencing).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `8`                                                                |
| `config.numJournalCallbackThreads`               | The number of threads that should handle journal callbacks                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `8`                                                                |
| `config.numReadWorkerThreads`                    | The number of threads that should handle read requests. if zero, the reads would be handled by netty threads directly.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `8`                                                                |
| `config.openFileLimit`                           | Max number of ledger index files could be opened in bookie server If number of ledger index files reaches this limitation, bookie server started to swap some ledgers from memory to disk. Too frequent swap will affect performance. You can tune this number to gain performance according your requirements.                                                                                                                                                                                                                                                                                                                     | `0`                                                                |
| `config.openLedgerRereplicationGracePeriod`      | The grace period, in milliseconds, that the replication worker waits before fencing and replicating a ledger fragment that's still being written to upon bookie failure.                                                                                                                                                                                                                                                                                                                                                                                                                                                            | `30000`                                                            |
| `config.pageLimit`                               | How many index pages provided in ledger cache If number of index pages reaches this limitation, bookie server starts to swap some ledgers from memory to disk. You can increment this value when you found swap became more frequent. But make sure pageLimit*pageSize should not more than JVM max memory limitation, otherwise you would got OutOfMemoryException. In general, incrementing pageLimit, using smaller index page would gain better performance in lager number of ledgers with fewer entries case If pageLimit is -1, bookie server will use 1/3 of JVM memory to compute the limitation of number of index pages. | `0`                                                                |
| `config.pageSize`                                | Size of a index page in ledger cache, in bytes A larger index page can improve performance writing page to disk, which is efficient when you have small number of ledgers and these ledgers have similar number of entries. If you have large number of ledgers and each ledger has fewer entries, smaller index page would improve memory usage.                                                                                                                                                                                                                                                                                   | `8192`                                                             |
| `config.persistBookieStatusEnabled`              | Persist the bookie status locally on the disks. So the bookies can keep their status upon restarts.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `false`                                                            |
| `config.prometheusStatsHttpPort`                 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `8000`                                                             |
| `config.readBufferSizeBytes`                     | The number of bytes we should use as capacity for BufferedReadChannel.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `4096`                                                             |
| `config.readOnlyModeEnabled`                     | If all ledger directories configured are full, then support only read requests for clients. If "readOnlyModeEnabled=true" then on all ledger disks full, bookie will be converted to read-only mode and serve only read requests. Otherwise the bookie will be shutdown. By default this will be disabled.                                                                                                                                                                                                                                                                                                                          | `true`                                                             |
| `config.rereplicationEntryBatchSize`             | The number of max entries to keep in fragment for re-replication                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `100`                                                              |
| `config.serverSockKeepalive`                     | This setting is used to send keep-alive messages on connection-oriented sockets.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `true`                                                             |
| `config.serverTcpLinger`                         | The socket linger timeout on close. When enabled, a close or shutdown will not return until all queued messages for the socket have been successfully sent or the linger timeout has been reached. Otherwise, the call returns immediately and the closing is done in the background.                                                                                                                                                                                                                                                                                                                                               | `0`                                                                |
| `config.serverTcpNoDelay`                        | This settings is used to enabled/disabled Nagle’s algorithm, which is a means of improving the efficiency of TCP/IP networks by reducing the number of packets that need to be sent over the network. If you are sending many small messages, such that more than one can fit in a single IP packet, setting server.tcpnodelay to false to enable Nagle algorithm can provide better performance.                                                                                                                                                                                                                                   | `true`                                                             |
| `config.skipListArenaChunkSize`                  | The number of bytes that we should use as chunk allocation for org.apache.bookkeeper.bookie.SkipListArena.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `4194304`                                                          |
| `config.skipListArenaMaxAllocSize`               | The maximum size that we should allocate from the skiplist arena. Allocations larger than this should be allocated directly by the VM to avoid fragmentation.                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `131072`                                                           |
| `config.sortedLedgerStorageEnabled`              | Whether sorted-ledger storage is enabled.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | `true`                                                             |
| `config.statsProviderClass`                      |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `org.apache.bookkeeper.stats.prometheus.PrometheusMetricsProvider` |
| `config.useHostNameAsBookieID`                   | Whether the bookie should use its hostname to register with the coordination service (e.g.: zookeeper service). When false, bookie will use its ip address for the registration.                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `true`                                                             |
| `config.verifyMetadataOnGC`                      | True if the bookie should double check readMetadata prior to GC.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `false`                                                            |
| `config.writeBufferSizeBytes`                    | The number of bytes used as capacity for the write buffer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | `65536`                                                            |
| `config.zkEnableSecurity`                        | Set ACLs on every node written on ZooKeeper, allowing users to read and write BookKeeper metadata stored on ZooKeeper. In order to make ACLs work you need to setup ZooKeeper JAAS authentication. All the bookies and Client need to share the same user, and this is usually done using Kerberos authentication. See ZooKeeper documentation.                                                                                                                                                                                                                                                                                     | `false`                                                            |
| `config.zkRetryBackoffMaxMs`                     | The maximum time that the Zookeeper client backoff retries in milliseconds.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `10000`                                                            |
| `config.zkRetryBackoffStartMs`                   | The start time that the Zookeeper client backoff retries in milliseconds.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | `1000`                                                             |
| `config.zkTimeout`                               | ZooKeeper client session timeout in milliseconds Bookie server will exit if it received SESSION_EXPIRED because it was partitioned off from ZooKeeper for more than the session timeout JVM garbage collection, disk I/O will cause SESSION_EXPIRED. Increment this value could help avoiding this issue                                                                                                                                                                                                                                                                                                                            | `30000`                                                            |


### Service parameters

Component application controller service and service account parameters. Note the data-store's service is headless because it only needs to communicate with other cluster components.

| Name                                          | Description                                                                                | Value  |
| --------------------------------------------- | ------------------------------------------------------------------------------------------ | ------ |
| `service.ports.client`                        | Component application controller unsecure service port                                     | `3181` |
| `service.ports.clientTls`                     | Component application controller unsecure service port                                     | `3182` |
| `service.ports.stateStorage`                  | Port for function worker interactions when state storage is enabled                        | `4181` |
| `service.annotations`                         | Additional custom annotations for Component application controller service                 | `{}`   |
| `service.extraPorts`                          | Extra ports to expose (normally used with the `sidecar` value)                             | `[]`   |
| `serviceAccount.create`                       | Specifies whether a ServiceAccount should be created                                       | `true` |
| `serviceAccount.automountServiceAccountToken` | Automount service account token for the server service account                             | `true` |
| `serviceAccount.annotations`                  | Annotations for service account. Evaluated as a template. Only used if `create` is `true`. | `{}`   |
| `podDisruptionBudget.enabled`                 | Enable the disruption budget                                                               | `true` |
| `podDisruptionBudget.maxUnavailable`          | When enabled the maximum allowed unavailable for matchLabel objects                        | `1`    |


### Other Parameters

| Name                                    | Description                                                                                                                                                                                   | Value                           |
| --------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------- |
| `podManagementPolicy`                   | StatefulSet controller supports relax its ordering guarantees while preserving its uniqueness and identity guarantees. There are two valid pod management policies: OrderedReady and Parallel | `Parallel`                      |
| `updateStrategy.type`                   | Bookkeeper statefulset strategy type                                                                                                                                                          | `RollingUpdate`                 |
| `updateStrategy.rollingUpdate`          | Bookkeeper statefulset rolling update configuration parameters                                                                                                                                | `{}`                            |
| `podLabels`                             | Extra labels for Bookkeeper pods                                                                                                                                                              | `{}`                            |
| `podAnnotations`                        | Extra annotations for Bookkeeper pods                                                                                                                                                         | `{}`                            |
| `hostAliases`                           | Bookkeeper pods host aliases                                                                                                                                                                  | `[]`                            |
| `hostNetwork`                           | Specify if host network should be enabled for Bookkeeper pods                                                                                                                                 | `false`                         |
| `hostIPC`                               | Specify if host IPC should be enabled for Bookkeeper pods                                                                                                                                     | `false`                         |
| `schedulerName`                         | Name of the k8s scheduler (other than default)                                                                                                                                                | `""`                            |
| `affinity`                              | Affinity for pod assignment                                                                                                                                                                   | `{}`                            |
| `podAffinityPreset`                     | Pod affinity preset. Ignored if `affinity` is set. Allowed values: `soft` or `hard`                                                                                                           | `""`                            |
| `podAntiAffinityPreset`                 | Pod anti-affinity preset. Ignored if `affinity` is set. Allowed values: `soft` or `hard`                                                                                                      | `hard`                          |
| `nodeAffinityPreset.type`               | Node affinity preset type. Ignored if `affinity` is set. Allowed values: `soft` or `hard`                                                                                                     | `""`                            |
| `nodeAffinityPreset.key`                | Node label key to match Ignored if `affinity` is set.                                                                                                                                         | `""`                            |
| `nodeAffinityPreset.values`             | Node label values to match. Ignored if `affinity` is set.                                                                                                                                     | `[]`                            |
| `nodeSelector`                          | Node labels for pod assignment                                                                                                                                                                | `{}`                            |
| `tolerations`                           | Tolerations for pod assignment                                                                                                                                                                | `[]`                            |
| `topologySpreadConstraints`             | Topology Spread Constraints for pod assignment spread across your cluster among failure-domains. Evaluated as a template                                                                      | `[]`                            |
| `terminationGracePeriodSeconds`         | Seconds the pod needs to gracefully terminate                                                                                                                                                 | `60`                            |
| `priorityClassName`                     | Name of the existing priority class to be used by Bookkeeper pods                                                                                                                             | `""`                            |
| `podSecurityContext.enabled`            | Enable security context for the pods                                                                                                                                                          | `true`                          |
| `podSecurityContext.fsGroup`            | Set Bookkeeper pod's Security Context fsGroup                                                                                                                                                 | `1001`                          |
| `containerSecurityContext.enabled`      | Enable Bookkeeper containers' Security Context                                                                                                                                                | `true`                          |
| `containerSecurityContext.runAsUser`    | Set Bookkeeper containers' Security Context runAsUser                                                                                                                                         | `1001`                          |
| `containerSecurityContext.runAsNonRoot` | Set Bookkeeper containers' Security Context runAsNonRoot                                                                                                                                      | `true`                          |
| `containerCommand`                      | Override the container image ENTRYPOINT. Leave blank to use image default (if set)                                                                                                            | `["/pulsar/bin/pulsar bookie"]` |
| `containerArgs`                         | Override the container image CMD. Leave blank to use image default (if set)                                                                                                                   | `[]`                            |
| `extraEnvVars`                          | Extra environment variables to add to the provisioning pod                                                                                                                                    | `[]`                            |
| `extraEnvVarsCM`                        | ConfigMap with extra environment variables                                                                                                                                                    | `""`                            |
| `extraEnvVarsSecret`                    | Secret with extra environment variables                                                                                                                                                       | `""`                            |
| `initContainers`                        | Add additional Add init containers to the Bookkeeper pod(s)                                                                                                                                   | `[]`                            |
| `containerPorts.client`                 | Data store client container port. Leave blank to turn off the port                                                                                                                            | `3181`                          |


### Persistence parameters

| Name                                | Description                                                                                                     | Value                  |
| ----------------------------------- | --------------------------------------------------------------------------------------------------------------- | ---------------------- |
| `persistence.enabled`               | Enable Bookkeeper data persistence using PVC                                                                    | `true`                 |
| `persistence.mountPath`             | The base mount path for pulsar environment and configurations                                                   | `/pulsar`              |
| `persistence.oneDisk.enabled`       | Combine the journals, ledgers, and ranges volumes into one. This overrides individual disk settings             | `false`                |
| `persistence.oneDisk.existingClaim` | A manually managed Persistent Volume and Claim                                                                  | `""`                   |
| `persistence.oneDisk.mountPath`     | The container mounting path                                                                                     | `/pulsar/data`         |
| `persistence.oneDisk.size`          | PVC storage size                                                                                                | `75Gi`                 |
| `persistence.oneDisk.accessModes`   | Persistent Volume Access Modes                                                                                  | `["ReadWriteOnce"]`    |
| `persistence.oneDisk.storageClass`  | PVC Storage Class for Kafka data volume                                                                         | `nil`                  |
| `persistence.oneDisk.annotations`   | Annotations for the PVC                                                                                         | `{}`                   |
| `persistence.oneDisk.selector`      | Selector to match an existing Persistent Volume. If set, the PVC can't have a PV dynamically provisioned for it | `{}`                   |
| `persistence.journal.mountPath`     | The container mount path                                                                                        | `/pulsar/data/journal` |
| `persistence.journal.size`          | PVC storage size                                                                                                | `20Gi`                 |
| `persistence.journal.storageClass`  | PVC Storage Class for Kafka data volume                                                                         | `nil`                  |
| `persistence.journal.existingClaim` | A manually managed Persistent Volume and Claim                                                                  | `""`                   |
| `persistence.journal.accessModes`   | Persistent Volume Access Modes                                                                                  | `["ReadWriteOnce"]`    |
| `persistence.journal.annotations`   | Annotations for the PVC                                                                                         | `{}`                   |
| `persistence.journal.selector`      | Selector to match an existing Persistent Volume. If set, the PVC can't have a PV dynamically provisioned for it | `{}`                   |
| `persistence.ledgers.mountPath`     | The container mount path                                                                                        | `/pulsar/data/ledgers` |
| `persistence.ledgers.size`          | PVC storage size                                                                                                | `50Gi`                 |
| `persistence.ledgers.storageClass`  | PVC Storage Class for Kafka data volume                                                                         | `nil`                  |
| `persistence.ledgers.existingClaim` | A manually managed Persistent Volume and Claim                                                                  | `""`                   |
| `persistence.ledgers.accessModes`   | Persistent Volume Access Modes                                                                                  | `["ReadWriteOnce"]`    |
| `persistence.ledgers.annotations`   | Annotations for the PVC                                                                                         | `{}`                   |
| `persistence.ledgers.selector`      | Selector to match an existing Persistent Volume. If set, the PVC can't have a PV dynamically provisioned for it | `{}`                   |
| `persistence.ranges.mountPath`      | The container mount path                                                                                        | `/pulsar/data/ranges`  |
| `persistence.ranges.size`           | PVC storage size                                                                                                | `5Gi`                  |
| `persistence.ranges.storageClass`   | PVC Storage Class for data volume                                                                               | `-`                    |
| `persistence.ranges.existingClaim`  | A manually managed Persistent Volume and Claim                                                                  | `""`                   |
| `persistence.ranges.accessModes`    | Persistent Volume Access Modes                                                                                  | `["ReadWriteOnce"]`    |
| `persistence.ranges.annotations`    | Annotations for the PVC                                                                                         | `{}`                   |
| `persistence.ranges.selector`       | Selector to match an existing Persistent Volume. If set, the PVC can't have a PV dynamically provisioned for it | `{}`                   |
| `logPersistence.mountPath`          | Mount path of Pulsar home                                                                                       | `/pulsar/logs`         |
| `logPersistence.size`               | PVC storage size                                                                                                | `5Gi`                  |
| `logPersistence.storageClass`       | PVC Storage Class for Kafka data volume                                                                         | `nil`                  |
| `logPersistence.existingClaim`      | A manually managed Persistent Volume and Claim                                                                  | `""`                   |
| `logPersistence.accessModes`        | Persistent Volume Access Modes                                                                                  | `["ReadWriteOnce"]`    |
| `logPersistence.annotations`        | Annotations for the PVC                                                                                         | `{}`                   |
| `logPersistence.selector`           | Selector to match an existing Persistent Volume. If set, the PVC can't have a PV dynamically provisioned for it | `{}`                   |


### Pod Liveness & Readyness

| Name                                 | Description                                                                                   | Value                     |
| ------------------------------------ | --------------------------------------------------------------------------------------------- | ------------------------- |
| `livenessProbe.enabled`              | Enable livenessProbe on Bookkeeper containers                                                 | `true`                    |
| `livenessProbe.httpGet.path`         | Endpoint to probe                                                                             | `/api/v1/bookie/is_ready` |
| `livenessProbe.httpGet.port`         | Endpoint port to probe                                                                        | `8000`                    |
| `livenessProbe.initialDelaySeconds`  | Initial delay seconds for livenessProbe                                                       | `10`                      |
| `livenessProbe.periodSeconds`        | Period seconds for livenessProbe                                                              | `30`                      |
| `livenessProbe.timeoutSeconds`       | Timeout seconds for livenessProbe                                                             | `5`                       |
| `livenessProbe.failureThreshold`     | Failure threshold for livenessProbe                                                           | `10`                      |
| `livenessProbe.successThreshold`     | Success threshold for livenessProbe                                                           | `1`                       |
| `readinessProbe.enabled`             | Enable readinessProbe on Bookkeeper containers                                                | `true`                    |
| `readinessProbe.httpGet.path`        | Endpoint path to probe                                                                        | `/api/v1/bookie/is_ready` |
| `readinessProbe.httpGet.port`        | Endpoint port to probe                                                                        | `8000`                    |
| `readinessProbe.initialDelaySeconds` | Initial delay seconds for readinessProbe                                                      | `10`                      |
| `readinessProbe.periodSeconds`       | Period seconds for readinessProbe                                                             | `30`                      |
| `readinessProbe.timeoutSeconds`      | Timeout seconds for readinessProbe                                                            | `5`                       |
| `readinessProbe.failureThreshold`    | Failure threshold for readinessProbe                                                          | `10`                      |
| `readinessProbe.successThreshold`    | Success threshold for readinessProbe                                                          | `1`                       |
| `startupProbe.enabled`               | Enable startupProbe on Bookkeeper containers                                                  | `false`                   |
| `startupProbe.initialDelaySeconds`   | Initial delay seconds for startupProbe                                                        | `30`                      |
| `startupProbe.periodSeconds`         | Period seconds for startupProbe                                                               | `10`                      |
| `startupProbe.timeoutSeconds`        | Timeout seconds for startupProbe                                                              | `1`                       |
| `startupProbe.failureThreshold`      | Failure threshold for startupProbe                                                            | `15`                      |
| `startupProbe.successThreshold`      | Success threshold for startupProbe                                                            | `1`                       |
| `customLivenessProbe`                | Custom livenessProbe that overrides the default one                                           | `{}`                      |
| `customReadinessProbe`               | Custom readinessProbe that overrides the default one                                          | `{}`                      |
| `customStartupProbe`                 | Custom startupProbe that overrides the default one                                            | `{}`                      |
| `lifecycleHooks`                     | lifecycleHooks for the Bookkeeper container to automate configuration before or after startup | `{}`                      |
| `resources.limits`                   | The resources limits for the container                                                        | `{}`                      |
| `resources.requests.memory`          | The requested resource memory for the container                                               | `2Gi`                     |
| `resources.requests.cpu`             | The requested resource cpu for the container                                                  | `1`                       |
| `extraVolumes`                       | Optionally specify extra list of additional volumes for the Bookkeeper pod(s)                 | `[]`                      |
| `extraVolumeMounts`                  | Optionally specify extra list of additional volumeMounts for the Bookkeeper container(s)      | `[]`                      |
| `sidecars`                           | Add additional sidecar containers to the Bookkeeper pod(s)                                    | `[]`                      |

