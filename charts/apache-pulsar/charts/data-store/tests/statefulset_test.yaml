suite: Test data-store statefulset
release:
  name: zz
  namespace: xx
templates:
  - charts/dataStore/templates/statefulset.yaml
  - charts/dataStore/templates/configmap.yaml
tests:
  - it: should be correct document
    asserts:
      - containsDocument:
          kind: StatefulSet
          apiVersion: apps/v1
    template: charts/dataStore/templates/statefulset.yaml

  - it: should have correct metadata
    set:
      global:
        commonLabels:
          aaa: bbb
        commonAnnotations:
          something: somewhere
    asserts:
      - equal:
          path: metadata
          value:
            annotations:
              something: somewhere
            labels:
              aaa: bbb
              app.kubernetes.io/component: data-store
              app.kubernetes.io/instance: zz
              app.kubernetes.io/managed-by: Helm
              app.kubernetes.io/name: data-store
              app.kubernetes.io/part-of: apache-pulsar
              helm.sh/chart: dataStore-0.1.0
            name: data-store-statefulset
            namespace: xx
    template: charts/dataStore/templates/statefulset.yaml

  - it: should have correct template metadata
    set:
      global:
        commonLabels:
          aaa: bbb
        commonAnnotations:
          something: somewhere
      restartOnConfigMapChange: true
    asserts:
      - equal:
          path: spec.template.metadata.labels
          value:
            app.kubernetes.io/component: data-store
            app.kubernetes.io/instance: zz
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: data-store
            helm.sh/chart: dataStore-0.1.0
    template: charts/dataStore/templates/statefulset.yaml

#  # TEST DISKS
  - it: should use one disk with default storage
    set:
      global:
        storageClass: local-path
      dataStore:
        persistence:
          enabled: true
          oneDisk:
            enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name:   oneDisk
            mountPath:  /pulsar/data/bookkeeper
        any: true
      - contains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: oneDisk
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 75Gi
              storageClassName: local-path
        any: true
    template: charts/dataStore/templates/statefulset.yaml

  - it: should use individual disks with default storage and custom naming
    set:
      global:
        storageClass: local-path
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: journal
            mountPath: /pulsar/data/bookkeeper/journal
        any: true
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: ledgers
            mountPath: /pulsar/data/bookkeeper/ledgers
        any: true
      - contains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: journal
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 20Gi
              storageClassName: local-path
        any: true
      - contains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: ledgers
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 50Gi
              storageClassName: local-path
    template: charts/dataStore/templates/statefulset.yaml

#  - it: should include ranges disk for state storage with custom name
#    set:
#      global:
#        functionWorker:
#          enabled: true
#          stateStorage:
#            enabled: true
#    asserts:
#      - contains:
#          path: spec.template.spec.containers[0].volumeMounts
#          content:
#            name: ranges
#            mountPath: /pulsar/data/bookkeeper/ranges
#      - contains:
#          path: spec.volumeClaimTemplates
#          content:
#            metadata:
#              name: ranges
#            spec:
#              accessModes:
#                - ReadWriteOnce
#              resources:
#                requests:
#                  storage: 5Gi
#              storageClassName: default
#    template: charts/dataStore/templates/statefulset.yaml

  - it: should override individual disk storageClassName with cloud storage class
    set:
      global:
        storageClass: local-path
        functionWorker:
          enabled: true
          stateStorage:
            enabled: true
      dataStore:
        persistence:
          journal:
            storageClassName:
            storageClass:
              provisioner: kubernetes.io/gce-pd
              type: pd-ssd
              fsType: ext4
              extraParams:
                replication-type: none
          ledgers:
            storageClassName:
            storageClass:
              provisioner: kubernetes.io/gce-pd
              type: pd-ssd
              fsType: ext4
              extraParams:
                replication-type: none
          ranges:
            storageClassName:
            storageClass:
              provisioner: kubernetes.io/gce-pd
              type: pd-ssd
              fsType: ext4
              extraParams:
                replication-type: none
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: journal
            mountPath: /pulsar/data/bookkeeper/journal
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: ledgers
            mountPath: /pulsar/data/bookkeeper/ledgers
#      - contains:
#          path: spec.template.spec.containers[0].volumeMounts
#          content:
#            name: ranges
#            mountPath: /pulsar/data/bookkeeper/ranges
      - contains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: journal
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 20Gi
              storageClassName: local-path
      - contains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: ledgers
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 50Gi
              storageClassName: local-path
#      - contains:
#          path: spec.volumeClaimTemplates
#          content:
#            metadata:
#              name: ranges
#            spec:
#              accessModes:
#                - ReadWriteOnce
#              resources:
#                requests:
#                  storage: 5Gi
#              storageClassName: local-path
    template: charts/dataStore/templates/statefulset.yaml

  - it: should override one disk storageClassName with cloud storage class
    set:
      global:
        storageClass: local-path
      dataStore:
        persistence:
          oneDisk:
            enabled: true
            storageClassName:
            storageClass:
              provisioner: kubernetes.io/gce-pd
              type: pd-ssd
              fsType: ext4
              extraParams:
                replication-type: none
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: oneDisk
            mountPath: /pulsar/data/bookkeeper
      - contains:
          path: spec.volumeClaimTemplates
          content:
            metadata:
              name: oneDisk
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 75Gi
              storageClassName: local-path
    template: charts/dataStore/templates/statefulset.yaml
