suite: Test data-store config map
release:
  name: zz
  namespace: xx
templates:
  - charts/dataStore/templates/configmap.yaml
tests:
  - it: should be correct document
    asserts:
      - containsDocument:
          kind: ConfigMap
          apiVersion: v1

  - it: should have correct metadata
    set:
      global:
        commonLabels:
          aaa: bbb
        commonAnnotations:
          something: somewhere
    asserts:
      - equal:
          path: metadata
          value:
            annotations:
              something: somewhere
            labels:
              aaa: bbb
              app.kubernetes.io/component: data-store
              app.kubernetes.io/instance: zz
              app.kubernetes.io/managed-by: Helm
              app.kubernetes.io/name: data-store
              app.kubernetes.io/part-of: apache-pulsar
              helm.sh/chart: dataStore-0.1.0
            name: data-store-configuration
            namespace: xx

  - it: should have correct zk server addresses
    set:
      global:
        clusterDomain: domain.com
        interComponentTls:
          enabled: false
        metaDataStore:
          replicas: 2
          nonPersistentReplicas: 1
          service:
            ports:
              client: 123
              clientTls: 456
    asserts:
      - matchRegex:
          path: data.bookkeeper\.conf
          pattern: "zkServers=meta-data-store-statefulset-0.meta-data-store-headless.xx.svc.domain.com:123,meta-data-store-statefulset-1.meta-data-store-headless.xx.svc.domain.com:123,meta-data-store-statefulset-non-persistent-0.meta-data-store-headless.xx.svc.domain.com:123"

  - it: should have correct zk secure server addresses
    set:
      global:
        clusterDomain: domain.com
        interComponentTls:
          enabled: true
        metaDataStore:
          replicas: 1
          nonPersistentReplicas: 1
          service:
            ports:
              client: 123
              clientTls: 456
    asserts:
      - matchRegex:
          path: data.bookkeeper\.conf
          pattern: "zkServers=meta-data-store-statefulset-0.meta-data-store-headless.xx.svc.domain.com:456,meta-data-store-statefulset-non-persistent-0.meta-data-store-headless.xx.svc.domain.com:456"
      - matchRegex:
          path: data.bookkeeper\.conf
          pattern: "metadataServiceUri=metadata-store:zk:meta-data-store-statefulset-0.meta-data-store-headless.xx.svc.domain.com:456,meta-data-store-statefulset-non-persistent-0.meta-data-store-headless.xx.svc.domain.com:456"

  - it: should have tls enabled
    set:
      global:
        interComponentTls:
          enabled: true
      dataStore:
        service:
          ports:
            client: 123
            clientTls: 456
    asserts:
      - matchRegex:
          path: data.bookkeeper\.conf
          pattern: "bookiePort=456"
      - matchRegex:
          path: data.bookkeeper\.conf
          pattern: "tlsProvider=JDK"
      - matchRegex:
          path: data.bookkeeper\.conf
          pattern: "tlsProviderFactoryClass=org.apache.bookkeeper.tls.TLSContextFactor"
      - matchRegex:
          path: data.bookkeeper\.conf
          pattern: "tlsClientAuthentication=true"
      - matchRegex:
          path: data.bookkeeper\.conf
          pattern: "tlsKeyStoreType=JKS"
      - matchRegex:
          path: data.bookkeeper\.conf
          pattern: "tlsKeyStore=/pulsar/jks/keystore.jks"
      - matchRegex:
          path: data.bookkeeper\.conf
          pattern: "tlsKeyStorePasswordPath=/pulsar/jks/jks-password"
      - matchRegex:
          path: data.bookkeeper\.conf
          pattern: "tlsTrustStoreType=JKS"
      - matchRegex:
          path: data.bookkeeper\.conf
          pattern: "tlsTrustStore=/pulsar/jks/truststore.jks"
      - matchRegex:
          path: data.bookkeeper\.conf
          pattern: "tlsTrustStorePasswordPath=/pulsar/jks/jks-password"

  - it: should have extra opts for ssl
    set:
      global:
        interComponentTls:
          enabled: true
    asserts:
      - matchRegex:
          path: data.pulsar_env\.sh
          pattern: "-Djavax.net.ssl.trustStorePassword=/pulsar/jks/jks-password"
      - matchRegex:
          path: data.pulsar_env\.sh
          pattern: "-Djavax.net.ssl.keyStorePassword=/pulsar/jks/jks-password"
      - matchRegex:
          path: data.pulsar_env\.sh
          pattern: "-Djavax.net.ssl.keyStore=/pulsar/jks/keystore.jks"
      - matchRegex:
          path: data.pulsar_env\.sh
          pattern: "-Djavax.net.ssl.trustStore=/pulsar/jks/truststore.jks"