suite: Test broker config map
release:
  name: zz
  namespace: xx
templates:
  - charts/broker/templates/configmap.yaml
tests:
  - it: should be correct document
    asserts:
      - containsDocument:
          kind: ConfigMap
          apiVersion: v1

  - it: should have correct metadata
    set:
      global:
        commonLabels:
          aaa: bbb
        commonAnnotations:
          something: somewhere
    asserts:
      - equal:
          path: metadata
          value:
            annotations:
              something: somewhere
            labels:
              aaa: bbb
              app.kubernetes.io/component: broker
              app.kubernetes.io/instance: zz
              app.kubernetes.io/managed-by: Helm
              app.kubernetes.io/name: broker
              app.kubernetes.io/part-of: apache-pulsar
              helm.sh/chart: broker-0.1.0
            name: broker-configuration
            namespace: xx

  - it: should add client tls settings to JVM environment
    set:
      global:
        interComponentTls:
          enabled: true
    asserts:
      - matchRegex:
          path: data.pulsar_env\.sh
          pattern: "-Dzookeeper.client.secure=true"
      - matchRegex:
          path: data.pulsar_env\.sh
          pattern: "-Dzookeeper.clientCnxnSocket=org.apache.zookeeper.ClientCnxnSocketNetty"
      - matchRegex:
          path: data.pulsar_env\.sh
          pattern: "-Dzookeeper.ssl.trustStore.type=JKS"
      - matchRegex:
          path: data.pulsar_env\.sh
          pattern: "-Dzookeeper.ssl.trustStore.location=/pulsar/jks/truststore.jks"
      - matchRegex:
          path: data.pulsar_env\.sh
          pattern: "-Dzookeeper.ssl.trustStore.passwordPath=/pulsar/jks/jks-password"
      - matchRegex:
          path: data.pulsar_env\.sh
          pattern: "-Dzookeeper.ssl.keyStore.type=JKS"
      - matchRegex:
          path: data.pulsar_env\.sh
          pattern: "-Dzookeeper.ssl.keyStore.location=/pulsar/jks/keystore.jks"
      - matchRegex:
          path: data.pulsar_env\.sh
          pattern: "-Dzookeeper.ssl.keyStore.passwordPath=/pulsar/jks/jks-password"

  - it: should have correct meta data store service addresses
    set:
      global:
        interComponentTls:
          enabled: false
        metaDataStore:
          service:
            ports:
              client: 123
              clientTls: 456
        dataStore:
          service:
            ports:
              client: 678
              clientTls: 789
    asserts:
      - matchRegex:
          path: data.broker\.conf
          pattern: bookkeeperMetadataServiceUri=zk://meta-data-store-statefulset-0.meta-data-store-headless.xx.svc.cluster.local:123;meta-data-store-statefulset-non-persistent-0.meta-data-store-headless.xx.svc.cluster.local:123;meta-data-store-statefulset-non-persistent-1.meta-data-store-headless.xx.svc.cluster.local:123/ledgers
      - matchRegex:
          path: data.broker\.conf
          pattern: configurationMetadataStoreUrl=meta-data-store-statefulset-0.meta-data-store-headless.xx.svc.cluster.local:123,meta-data-store-statefulset-non-persistent-0.meta-data-store-headless.xx.svc.cluster.local:123,meta-data-store-statefulset-non-persistent-1.meta-data-store-headless.xx.svc.cluster.local:123/ledgers
      - matchRegex:
          path: data.broker\.conf
          pattern: metadataStoreUrl=meta-data-store-statefulset-0.meta-data-store-headless.xx.svc.cluster.local:123,meta-data-store-statefulset-non-persistent-0.meta-data-store-headless.xx.svc.cluster.local:123,meta-data-store-statefulset-non-persistent-1.meta-data-store-headless.xx.svc.cluster.local:123/ledgers

  - it: should have correct default ports
    set:
      global:
        interComponentTls:
          enabled: false
      broker:
        containerPorts:
          pulsar: 123
          pulsarSsl: 456
          http: 789
          https: 012
    asserts:
      - matchRegex:
          path: data.broker\.conf
          pattern: "brokerServicePort=123"
      - matchRegex:
          path: data.broker\.conf
          pattern: "brokerServicePortTls="
      - matchRegex:
          path: data.broker\.conf
          pattern: "webServicePort=789"
      - matchRegex:
          path: data.broker\.conf
          pattern: "webServicePortTls="

  - it: should have correct TLS ports
    set:
      global:
        interComponentTls:
          enabled: true
      broker:
        containerPorts:
          pulsar: 123
          pulsarSsl: 456
          http: 789
          https: 222
    asserts:
      - matchRegex:
          path: data.broker\.conf
          pattern: "brokerServicePort="
      - matchRegex:
          path: data.broker\.conf
          pattern: "brokerServicePortTls=456"
      - matchRegex:
          path: data.broker\.conf
          pattern: "webServicePort="
      - matchRegex:
          path: data.broker\.conf
          pattern: "webServicePortTls=222"